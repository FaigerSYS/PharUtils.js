/**
 * Utilities for working with Phar archives
 * https://github.com/FaigerSYS/PharUtils.js
 * @license PharUtils.js [The MIT License]
 * @copyright FaigerSYS 2017
 */
!function(){function t(t){for(var e=window.PharUtils_crcTable||(window.PharUtils_crcTable=function(){for(var t,e=[],r=0;r<256;r++){t=r;for(var i=0;i<8;i++)t=1&t?3988292384^t>>>1:t>>>1;e[r]=t}return e}()),r=-1,i=0;i<t.length;i++)r=r>>>8^e[255&(r^t.charCodeAt(i))];return(-1^r)>>>0}function e(t){for(var e=new Uint8Array(t.length),r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e}function r(t){for(var e="",r=0;r<t.length;r++)e+=String.fromCharCode(t[r]);return e}var i=!1;if(void 0===Zlib.RawInflate&&(i=!0,console.error("Zlib.RawInflate not found!")),void 0===Zlib.RawDeflate&&(i=!0,console.error("Zlib.RawDeflate not found!")),"undefined"==typeof Hashes&&(i=!0,console.error("Hashes not found!")),i)throw Error("Not all required libraries are installed!");var s={COMPRESSION_NONE:0,COMPRESSION_GZ:4096,COMPRESSION_BZIP2:8192,SIGNATURE_MD5:1,SIGNATURE_SHA1:2,SIGNATURE_SHA256:4,SIGNATURE_SHA512:8,END_MAGIC:"GBMB",STUB_END:"__HALT_COMPILER(); ?>\r\n",PharBuffer:function(t){return this.read=function(t){return t<0&&(t=Math.max(0,this.buffer.length-this.offset)),this.buffer.substring(this.offset,this.offset+=t)},this.readNumber=function(t){for(var e,r=this.read(t),i="",s=r.length-1;s>=0;s--)i+=2==(e=r.charCodeAt(s).toString(16)).length?e:"0"+e;return parseInt(i,16)},this.readString=function(t){return this.read(this.readNumber(t))},this.write=function(t){return this.buffer+=t,this},this.writeNumber=function(t,e){if(0==t)i="\0".repeat(e);else{var r=t.toString(16);r.length%2&&(r="0"+r);for(var i=r.length/2<e?"\0".repeat(e-r.length/2):"",s=0;s<r.length;s+=2)i=String.fromCharCode(parseInt(r.substring(s,s+2),16))+i}return this.write(i),this},this.writeString=function(t,e){return this.writeNumber(t.length,e),this.write(t),this},this.buffer=t||"",this.offset=0,this},Phar:function(i){return this.getStub=function(){return this.stub},this.setStub=function(t){var e=t.toLowerCase().indexOf("__halt_compiler();");if(-1==e)throw Error("Stub is invalid!");this.stub=t.substring(0,e)+s.STUB_END},this.getAlias=function(){return this.alias},this.setAlias=function(t){return this.alias=alias,this},this.getSignatureType=function(){return this.signature_type},this.setSignatureType=function(t){if(t!=s.SIGNATURE_MD5&&t!=s.SIGNATURE_SHA1&&t!=s.SIGNATURE_SHA256&&t!=s.SIGNATURE_SHA512)throw Error("Unknown signature type given!");return this.signature_type=t,this},this.getMetadata=function(){return this.metadata},this.setMetadata=function(t){return this.metadata=t,this},this.addFile=function(t){return this.files[t.getName()]=t,this},this.getFile=function(t){if(this.files[t])return this.files[t]},this.removeFile=function(t){return delete this.files[t],this},this.getFiles=function(){return this.files},this.setFiles=function(t){this.files={};for(var e in t)this.files[t[e].getName()]=t[e];return this},this.getFilesCount=function(){return Object.keys(this.files).length},this.getFlags=function(){return this.flags},this.setFlags=function(t){return this.flags=t,this},this.getManifestApi=function(){return this.manifest_api},this.setManifestApi=function(t){return this.manifest_api=t,this},this.loadFromContents=function(e){e instanceof Uint8Array&&(e=r(e));var i=e.length-8;switch(new s.PharBuffer(e.substring(i)).readNumber(4)){case s.SIGNATURE_MD5:var n=16,a=new Hashes.MD5({utf8:!1});break;case s.SIGNATURE_SHA1:var n=20,a=new Hashes.SHA1({utf8:!1});break;case s.SIGNATURE_SHA256:var n=32,a=new Hashes.SHA256({utf8:!1});break;case s.SIGNATURE_SHA512:var n=64,a=new Hashes.SHA512({utf8:!1});break;default:throw Error("Unknown signature type detected!")}for(var o=e.substring(i-n,i),h="",u=0;u<o.length;u++){var f=o.charCodeAt(u).toString(16);h+=2==f.length?f:"0"+f}if(e=e.substring(0,i-n),a.hex(e)!=h)throw Error("Phar has a broken signature!");var c=(e=new s.PharBuffer(e)).buffer.indexOf(s.STUB_END);if(-1==c)throw Error("Stub not found!");c+=s.STUB_END.length,this.stub=e.read(c);var l=e.readNumber(4),m=new s.PharBuffer(e.read(l));if(m.buffer.length!=l)throw Error("Unexpected manifest end!");var g=m.readNumber(4);this.manifest_api=m.readNumber(2),this.flags=m.readNumber(4),this.alias=m.readString(4),this.metadata=m.readString(4),this.files=[];for(var p=0;p<g;p++){var d={},S=m.readString(4);m.readNumber(4),d.timestamp=m.readNumber(4);var w=m.readNumber(4),b=m.readNumber(4),N=e.read(w);if(b!=t(N))throw new Error("Phar is corrupted! (file corrupt)");var _=m.readNumber(4);d.permission=4095&_,d.compression_type=61440&_,d.metadata=m.readString(4),d.is_compressed=!0,this.files[S]=new s.PharFile(S,N,d)}return this},this.saveAsContents=function(r){if(!this.getFilesCount())throw Error("Phar must have at least 1 file!");var i=new s.PharBuffer,n=new s.PharBuffer;i.write(this.stub),n.writeNumber(this.getFilesCount(),4),n.writeNumber(this.manifest_api,2),n.writeNumber(this.flags,4),n.writeString(this.alias,4),n.writeString(this.metadata,4);var a="";for(var o in this.files){var h=this.files[o];n.writeString(h.getName(),4),n.writeNumber(h.getSize(),4),n.writeNumber(h.getTimestamp(),4),n.writeNumber(h.getComressedSize(),4),n.writeNumber(t(h.getContents()),4),n.writeNumber(h.getPharFlags(),4),n.writeString(h.getMetadata(),4),a+=h.getCompressedContents()}switch(i.writeString(n.buffer,4),i.write(a),this.signature_type){case s.SIGNATURE_MD5:u=new Hashes.MD5({utf8:!1});break;case s.SIGNATURE_SHA1:u=new Hashes.SHA1({utf8:!1});break;case s.SIGNATURE_SHA256:u=new Hashes.SHA256({utf8:!1});break;case s.SIGNATURE_SHA512:var u=new Hashes.SHA512({utf8:!1});break;default:throw Error("Unknown signature type detected!")}for(var f="",o=(u=u.hex(i.buffer)).length-2;o>=0;o-=2)f=String.fromCharCode(parseInt(u.substring(o,o+2),16))+f;return i.write(f),i.writeNumber(this.signature_type,4),i.write(s.END_MAGIC),r?e(i.buffer):i.buffer},i=i||{},this.alias=i.alias||"",this.setStub(i.stub||"<?php "+s.STUB_END),this.setSignatureType(i.signature_type||s.SIGNATURE_SHA1),this.metadata=i.metadata||"",this.setFiles(i.files||{}),this.flags=i.flags||65536,this.manifest_api=i.manifest_api||17,this},PharFile:function(t,i,n){return this.getName=function(){return this.name},this.setName=function(t){this.name=t},this.getContents=function(){return this.contents},this.setContents=function(t,i){switch(this.compression_type){case s.COMPRESSION_NONE:this.contents=t,this.compressed_contents=null;break;case s.COMPRESSION_GZ:try{i?(this.compressed_contents=t,this.contents=r(new Zlib.RawInflate(e(t)).decompress())):(this.contents=t,this.compressed_contents=r(new Zlib.RawDeflate(e(t)).compress()))}catch(t){throw Error("Zlib error: "+t)}break;case s.COMPRESSION_BZIP2:throw Error("BZIP2 compression is not supported yet!");default:throw Error("Unknown compression type!")}return this},this.getCompressedContents=function(){return this.compression_type==s.COMPRESSION_NONE?this.contents:this.compressed_contents},this.getSize=function(){return this.getContents().length},this.getComressedSize=function(){return this.getCompressedContents().length},this.getCompressionType=function(){return this.compression_type},this.setCompressionType=function(t){if(t==this.compression_type)return this;switch(t){case s.COMPRESSION_NONE:this.compressed_contents=null;break;case s.COMPRESSION_GZ:try{this.compressed_contents=r(new Zlib.RawDeflate(e(this.contents)).compress())}catch(t){throw Error("Zlib error: "+t)}break;case s.COMPRESSION_BZIP2:throw Error("BZIP2 compression is not supported yet!");default:throw Error("Unknown compression type!")}return this.compression_type=t,this},this.getPermission=function(){return this.permission},this.setPermission=function(t){if(t>4095||t<0)throw Error("Permission number is too "+(t<0?"small":"large")+"!");return this.permission=t,this},this.getPharFlags=function(){return this.permission|this.compression_type},this.getTimestamp=function(){return this.timestamp},this.setTimestamp=function(t){return t<0&&(t=Date.now()/1e3|0),this.timestamp=t,this},this.getMetadata=function(){return this.metadata},this.setMetadata=function(t){return this.metadata=t,this},n=n||{},this.name=t||"NO_NAME",this.compression_type=n.compression_type||s.COMPRESSION_NONE,this.setContents(i||"",n.is_compressed||!1),this.setTimestamp(n.timestamp||-1),this.setPermission(n.permission||438),this.metadata=n.metadata||"",this}};void 0!==Zlib.Zip||void 0!==Zlib.Unzip?s.PharZipConverter={toZip:function(t,i){var s=new Zlib.Zip,n=t.getFiles();for(var a in n)s.addFile(e(n[a].getContents()),{filename:e(n[a].getName())});return i?s.compress():r(s.compress())},toPhar:function(t){if(t instanceof Zlib.Unzip)i=t;else if(t instanceof Uint8Array)i=new Zlib.Unzip(t);else var i=new Zlib.Unzip(e(t));var n=new s.Phar,a=[],o=i.getFilenames();for(var h in o)a.push(new s.PharFile(o[h],r(i.decompress(o[h]))));return n.setFiles(a),n}}:console.debug("Zlib.Zip or/and Zlib.Unzip not found, so PharZipConverter will not be loaded"),window.PharUtils=s}();