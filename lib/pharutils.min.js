/**
 * Utilities for working with Phar archives
 * https://github.com/FaigerSYS/PharUtils.js
 * @license PharUtils.js [The MIT License]
 * @copyright FaigerSYS 2018
 */
!function(){function t(t){for(var e=window.PharUtils_crcTable||(window.PharUtils_crcTable=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var r=0;r<8;r++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e}()),i=-1,r=0;r<t.length;r++)i=i>>>8^e[255&(i^t.charCodeAt(r))];return(-1^i)>>>0}function e(t){for(var e=new Uint8Array(t.length),i=0;i<t.length;i++)e[i]=t.charCodeAt(i);return e}function i(t){for(var e="",i=0;i<t.length;i++)e+=String.fromCharCode(t[i]);return e}var r=!1;if(void 0===Zlib.RawInflate&&(r=!0,console.error("Zlib.RawInflate not found!")),void 0===Zlib.RawDeflate&&(r=!0,console.error("Zlib.RawDeflate not found!")),"undefined"==typeof Hashes&&(r=!0,console.error("Hashes not found!")),r)throw Error("Required libraries are not installed!");var s={COMPRESSION_NONE:0,COMPRESSION_GZ:4096,COMPRESSION_BZIP2:8192,SUPPORTED_COMPRESSION:[0,4096],SIGNATURE_MD5:1,SIGNATURE_SHA1:2,SIGNATURE_SHA256:4,SIGNATURE_SHA512:8,END_MAGIC:"GBMB",STUB_END:"__HALT_COMPILER(); ?>\r\n",Binary:{readLInt:function(t){for(var e=0,i=0;i<4;i++)e|=t.charCodeAt(i)<<8*i;return e>>>0},writeLInt:function(t){for(var e="",i=0;i<4;i++)e+=String.fromCharCode(t>>8*i&255);return e},readLShort:function(t){for(var e=0,i=0;i<2;i++)e|=t.charCodeAt(i)<<8*i;return e},writeLShort:function(t){for(var e="",i=0;i<2;i++)e+=String.fromCharCode(t>>8*i&255);return e}},BinaryBuffer:function(t){return this.get=function(t){if(t<0&&(t=Math.max(0,this.buffer.length-this.offset)),0==t)return"";if((this.offset+=t)>this.buffer.length)throw Error("Buffer is accessed out of bounds!");return this.buffer.substring(this.offset-t,this.offset)},this.put=function(t){this.buffer+=t},this.getLInt=function(){return s.Binary.readLInt(this.get(4))},this.putLInt=function(t){this.put(s.Binary.writeLInt(t))},this.getLShort=function(){return s.Binary.readLShort(this.get(2))},this.putLShort=function(t){this.put(s.Binary.writeLShort(t))},this.getString=function(){return this.get(this.getLInt())},this.putString=function(t){this.putLInt(t.length),this.put(t)},this.buffer=t||"",this.offset=0,this},Phar:function(r){return this.getStub=function(){return this.stub},this.setStub=function(t){var e=t.toLowerCase().indexOf("__halt_compiler();");if(-1==e)throw Error("Stub is invalid!");this.stub=t.substring(0,e)+s.STUB_END},this.getAlias=function(){return this.alias},this.setAlias=function(t){return this.alias=alias,this},this.getSignatureType=function(){return this.signature_type},this.setSignatureType=function(t){if(t!=s.SIGNATURE_MD5&&t!=s.SIGNATURE_SHA1&&t!=s.SIGNATURE_SHA256&&t!=s.SIGNATURE_SHA512)throw Error("Unknown signature type given!");return this.signature_type=t,this},this.getMetadata=function(){return this.metadata},this.setMetadata=function(t){return this.metadata=t,this},this.addFile=function(t){return t instanceof s.PharFile&&(this.files[t.getName()]=t),this},this.getFile=function(t){if(this.files[t])return this.files[t]},this.removeFile=function(t){return delete this.files[t],this},this.getFiles=function(){return Object.assign({},this.files)},this.setFiles=function(t){this.files={};for(var e in t)this.addFile(t[e]);return this},this.getFilesCount=function(){return Object.keys(this.files).length},this.getFlags=function(){return this.flags},this.setFlags=function(t){return this.flags=t,this},this.getManifestApi=function(){return this.manifest_api},this.setManifestApi=function(t){return this.manifest_api=t,this},this.loadPharData=function(e){e instanceof Uint8Array&&(e=i(e));var r=e.length-4;if(e.substring(r)!=s.END_MAGIC)throw new Error("Phar is corrupted! (magic corrupt)");switch(r-=4,s.Binary.readLInt(e.substring(r,r+4))){case s.SIGNATURE_MD5:var n=16,a=new Hashes.MD5({utf8:!1});break;case s.SIGNATURE_SHA1:var n=20,a=new Hashes.SHA1({utf8:!1});break;case s.SIGNATURE_SHA256:var n=32,a=new Hashes.SHA256({utf8:!1});break;case s.SIGNATURE_SHA512:var n=64,a=new Hashes.SHA512({utf8:!1});break;default:throw Error("Unknown signature type detected!")}var o=e.substring(r-n,r);if(e=e.substring(0,r-n),a.raw(e)!=o)throw Error("Phar has a broken signature!");var h=e.indexOf(s.STUB_END);if(-1==h)throw Error("Stub not found!");h+=s.STUB_END.length,e=new s.BinaryBuffer(e),this.stub=e.get(h);var u=new s.BinaryBuffer(e.getString()),f=u.getLInt();this.manifest_api=u.getLShort(),this.flags=u.getLInt(),this.alias=u.getString(),this.metadata=u.getString(),this.files=[];for(var c=0;c<f;c++){var g={},l=u.getString();u.offset+=4,g.timestamp=u.getLInt();var p=u.getLInt(),S=u.getLInt(),m=u.getLInt();g.permission=4095&m,g.compression_type=61440&m,g.metadata=u.getString(),g.is_compressed=!0;var d=new s.PharFile(l,e.get(p),g);if(S!=t(d.getContents()))throw Error("Phar is corrupted! (file corrupt)");this.files[l]=d}return this},this.savePharData=function(i){if(!this.getFilesCount())throw Error("Phar must have at least one file!");var r=new s.BinaryBuffer,n=new s.BinaryBuffer;r.put(this.stub),n.putLInt(this.getFilesCount()),n.putLShort(this.manifest_api),n.putLInt(this.flags),n.putString(this.alias),n.putString(this.metadata);var a="";for(var o in this.files){var h=this.files[o],u=h.getCompressedContents();n.putString(h.getName()),n.putLInt(h.getSize()),n.putLInt(h.getTimestamp()),n.putLInt(u.length),n.putLInt(t(h.getContents())),n.putLInt(h.getPharFlags()),n.putString(h.getMetadata()),a+=u}switch(r.putString(n.buffer,4),r.put(a),a=null,this.signature_type){case s.SIGNATURE_MD5:f=new Hashes.MD5({utf8:!1});break;case s.SIGNATURE_SHA1:f=new Hashes.SHA1({utf8:!1});break;case s.SIGNATURE_SHA256:f=new Hashes.SHA256({utf8:!1});break;case s.SIGNATURE_SHA512:var f=new Hashes.SHA512({utf8:!1});break;default:throw Error("Unknown signature type detected!")}var c=f.raw(r.buffer);return r.put(c),r.putLInt(this.signature_type,4),r.put(s.END_MAGIC),i?e(r.buffer):r.buffer},r=r||{},this.alias=r.alias||"",this.setStub(r.stub||"<?php "+s.STUB_END),this.setSignatureType(r.signature_type||s.SIGNATURE_SHA1),this.metadata=r.metadata||"",this.setFiles(r.files||{}),this.flags=r.flags||65536,this.manifest_api=r.manifest_api||17,this},PharFile:function(t,r,n){return this.getName=function(){return this.name},this.setName=function(t){this.name=t},this.getContents=function(){return this.contents},this.setContents=function(t,r){if(r)switch(this.compression_type){case s.COMPRESSION_NONE:this.contents=t;break;case s.COMPRESSION_GZ:try{this.contents=i(new Zlib.RawInflate(e(t)).decompress())}catch(t){throw Error("Zlib error: "+t)}break;default:throw Error("Unsupported compression type detected!")}else this.contents=t;return this},this.getCompressedContents=function(){switch(this.compression_type){case s.COMPRESSION_GZ:try{return i(new Zlib.RawDeflate(e(this.contents)).compress())}catch(t){throw Error("Zlib error: "+t)}default:return this.contents}},this.getSize=function(){return this.getContents().length},this.getComressedSize=function(){return this.getCompressedContents().length},this.getCompressionType=function(){return this.compression_type},this.setCompressionType=function(t){if(-1==s.SUPPORTED_COMPRESSION.indexOf(t))throw Error("("+t+") compression type is not supported!");return this.compression_type=t,this},this.getPermission=function(){return this.permission},this.setPermission=function(t){if(t>4095||t<0)throw Error("Permission number is too "+(t<0?"small":"large")+"!");return this.permission=t,this},this.getPharFlags=function(){return this.permission|this.compression_type},this.getTimestamp=function(){return this.timestamp},this.setTimestamp=function(t){return t<0&&(t=Date.now()/1e3|0),this.timestamp=t,this},this.getMetadata=function(){return this.metadata},this.setMetadata=function(t){return this.metadata=t,this},n=n||{},this.name=t||"newfile",this.setCompressionType(n.compression_type||s.COMPRESSION_NONE),this.setContents(r||"",n.is_compressed||!1),this.setTimestamp(n.timestamp||-1),this.setPermission(n.permission||438),this.metadata=n.metadata||"",this}};void 0===Zlib.Zip&&void 0===Zlib.Unzip||(s.PharZipConverter={toZip:function(t){var i=new Zlib.Zip,r=t.getFiles();for(var s in r){var n=new Date;n.setTime(1e3*r[s].getTimestamp()),i.addFile(e(r[s].getContents()),{filename:e(r[s].getName()),date:n})}return i},toPhar:function(t,r){try{if(t instanceof Zlib.Unzip)n=t;else if(t instanceof Uint8Array)n=new Zlib.Unzip(t,{password:r});else var n=new Zlib.Unzip(e(t),{password:r})}catch(t){throw Error("Zlib.Unzip creation error: "+t)}var a=new s.Phar,o=n.getFilenames();try{for(var h in o)a.addFile(new s.PharFile(o[h],i(n.decompress(o[h]))))}catch(t){throw Error("Zlib.Unzip decompression error: "+t)}return a}}),window.PharUtils=s}();